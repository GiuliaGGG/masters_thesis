)
###################################################
### chunk number 13:
###################################################
path.plot(synth.res = synth.out,
dataprep.res = dataprep.out,
Ylab = "net_income_margin",
Xlab = "year",
Ylim = c(0,0.1),
Legend = c({boycotted_firm},"Synthetic {boycotted_firm}"),
Legend.position = "topleft"
)
###################################################
### chunk number 13:
###################################################
path.plot(synth.res = synth.out,
dataprep.res = dataprep.out,
Ylab = "net_income_margin",
Xlab = "year",
Ylim = c(0,0.1),
Legend = c({boycotted_firm},"Synthetic"{boycotted_firm}),
###################################################
### chunk number 13:
###################################################
path.plot(synth.res = synth.out,
dataprep.res = dataprep.out,
Ylab = "net_income_margin",
Xlab = "year",
Ylim = c(0,0.1),
Legend = c({boycotted_firm},'"Synthetic"{boycotted_firm}'),
Legend.position = "topleft"
)
###################################################
### chunk number 13:
###################################################
path.plot(synth.res = synth.out,
dataprep.res = dataprep.out,
Ylab = "net_income_margin",
Xlab = "year",
Ylim = c(0,0.1),
Legend = c({boycotted_firm}, Synthetic{boycotted_firm}),
###################################################
### chunk number 13:
###################################################
path.plot(
synth.res = synth.out,
dataprep.res = dataprep.out,
Ylab = "net_income_margin",
Xlab = "year",
Ylim = c(0, 0.1),
Legend = c(
paste0(boycotted_firm),
paste0("Synthetic ", boycotted_firm)
),
Legend.position = "topleft"
)
abline(v = 2023.25, col = "red", lwd = 2, lty = 2)  # vertical red line at 2023.75
# dataprep
dataprep.out <- dataprep(
foo = df_clean,
predictors = c("assets", 'shares_basic','cash', 'equity'),
dependent = "net_income_margin",
unit.variable = "company_id",          # numeric ID column
unit.names.variable = "ticker",        # readable name
time.variable = "time_numeric",                  # or numeric time index
treatment.identifier = 8,              # treated company ID
controls.identifier = c(1:7, 9:17), # control company IDs
time.predictors.prior = 2010.25:2023.75,
time.optimize.ssr = 2010.25:2023.75,         # pre-treatment period
time.plot = 2010.25:2025.75                  # full period to plot
)
library(gsynth)
data(gsynth)
ls()
head(simdata)
## devtools::install_github('xuyiqing/panelView')   # if not already installed
library(panelView)
panelview(net_income_margin ~ boycotted, data = df_clean,  index = c("company_id","time_numeric"), pre.post = TRUE)
panelview(net_income_margin ~ boycotted, data = df_clean,  index = c("company_id","time_numeric"), type = "outcome")
library(gsynth)
function (package, help, pos = 2, lib.loc = NULL, character.only = FALSE,
logical.return = FALSE, warn.conflicts, quietly = FALSE,
verbose = getOption("verbose"), mask.ok, exclude, include.only,
attach.required = missing(include.only))
library(gsynth)
data(gsynth)
ls()
head(simdata)
## devtools::install_github('xuyiqing/panelView')   # if not already installed
library(panelView)
panelview(net_income_margin ~ boycotted, data = df_clean,  index = c("company_id","time_numeric"), pre.post = TRUE)
panelview(net_income_margin ~ boycotted, data = df_clean,  index = c("company_id","time_numeric"), type = "outcome")
system.time(
out <- gsynth(net_income_margin ~ boycotted +shares_basic+ assets + cash + equity, data = df_clean,
index = c("company_id","time_numeric"), force = "two-way",
CV = TRUE, r = c(0, 5), se = TRUE,
inference = "parametric", nboots = 1000,
parallel = FALSE)
)
out2 <- gsynth(Y ~ D + X1 + X2, data = simdata,
index = c("id","time"), force = "two-way",
CV = FALSE, r = c(2, 5), se = TRUE,
inference = "jackknife",
parallel = TRUE, cores = 4)
cumu1 <- cumuEff(out, cumu = TRUE, id = NULL, period = c(0,5))
cumu1$est.catt
cumu2 <- cumuEff(out, cumu = FALSE, id = c(101, 102, 103), period = c(0,5))
cumu2$est.catt
plot(out) # by default
plot(out, theme.bw = FALSE)
plot(out, type = "gap", ylim = c(-3,12), xlab = "Period",
main = "My GSynth Plot")
plot(out, type = "raw")
plot(out,type = "raw", legendOff = TRUE, ylim=c(-10,40), main="")
plot(out, type = "counterfactual", raw = "none", main="")
plot(out, type = "ct", raw = "none", main = "",
shade.post = FALSE)
library(tidysynth)
devtools::install_github("edunford/tidysynth")
require(tidysynth)
data("smoking")
df_clean %>% dplyr::glimpse()
df_out <-
df_clean %>%
# initial the synthetic control object
synthetic_control(outcome = net_income_margin, # outcome
unit = ticker, # unit index in the panel data
time = time_numeric, # time index in the panel data
i_unit = boycotted_firm, # unit where the intervention occurred
i_time = 2023.25, # time period when the intervention occurred
generate_placebos=T # generate placebo synthetic controls (for inference)
) %>%
# Generate the aggregate predictors used to fit the weights
# average log income, retail price of cigarettes, and proportion of the
# population between 15 and 24 years of age from 1980 - 1988
generate_predictor(time_window = 2009.25:2025.75,
shares_basic = mean(shares_basic, na.rm = T),
assets = mean(assets, na.rm = T),
equity = mean(equity, na.rm = T),
cash = mean(cash, na.rm = T)) %>%
#
# # average in the donor pool from 1984 - 1988
# Purpose: match underlying demographic/economic environment
generate_predictor(time_window = 2018:2022,
avg_revenue = mean(revenue),
avg_assets = mean(assets))
# # Lagged net_income_margin
generate_predictor(time_window = 2019,
margin_2019 = net_income_margin)
df_out <-
df_clean %>%
# initial the synthetic control object
synthetic_control(outcome = net_income_margin, # outcome
unit = ticker, # unit index in the panel data
time = time_numeric, # time index in the panel data
i_unit = boycotted_firm, # unit where the intervention occurred
i_time = 2023.25, # time period when the intervention occurred
generate_placebos=T # generate placebo synthetic controls (for inference)
) %>%
# Generate the aggregate predictors used to fit the weights
# average log income, retail price of cigarettes, and proportion of the
# population between 15 and 24 years of age from 1980 - 1988
generate_predictor(time_window = 2009.25:2025.75,
shares_basic = mean(shares_basic, na.rm = T),
assets = mean(assets, na.rm = T),
equity = mean(equity, na.rm = T),
cash = mean(cash, na.rm = T)) %>%
#
# # average in the donor pool from 1984 - 1988
# Purpose: match underlying demographic/economic environment
generate_predictor(time_window = 2018:2022,
avg_shares = mean(shares_basic),
avg_assets = mean(assets))
# # Lagged net_income_margin
generate_predictor(time_window = 2019,
margin_2019 = net_income_margin)
# # Lagged net_income_margin
generate_predictor(time_numeric = 2019,
margin_2019 = net_income_margin)
df_out <-
df_clean %>%
# initial the synthetic control object
synthetic_control(outcome = net_income_margin, # outcome
unit = ticker, # unit index in the panel data
time = time_numeric, # time index in the panel data
i_unit = boycotted_firm, # unit where the intervention occurred
i_time = 2023.25, # time period when the intervention occurred
generate_placebos=T # generate placebo synthetic controls (for inference)
) %>%
# Generate the aggregate predictors used to fit the weights
# average log income, retail price of cigarettes, and proportion of the
# population between 15 and 24 years of age from 1980 - 1988
generate_predictor(time_window = 2009.25:2025.75,
shares_basic = mean(shares_basic, na.rm = T),
assets = mean(assets, na.rm = T),
equity = mean(equity, na.rm = T),
cash = mean(cash, na.rm = T)) %>%
#
# # average in the donor pool from 1984 - 1988
# Purpose: match underlying demographic/economic environment
generate_predictor(time_window = 2009.25:2023.25,
avg_shares = mean(shares_basic),
avg_assets = mean(assets))
# # Lagged net_income_margin
generate_predictor(time_window = 2019,
margin_2019 = net_income_margin)
library(tidysynth)
devtools::install_github("edunford/tidysynth")
require(tidysynth)
data("smoking")
df_clean %>% dplyr::glimpse()
df <- read_csv("data/merged_dataset_2025-11-18_13-31.csv")
boycotted_firm = "MCD"
###################################################
### chunk number 1:
###################################################
library("Synth")
library(readr)
library(dplyr)
library(skimr)
library(tidyr)
library(ggplot2)
df <- read_csv("data/merged_dataset_2025-11-18_13-31.csv")
boycotted_firm = "MCD"
# Preprocessing
df_clean <- df %>%
# in a df with many boycotted, just pick one
filter( (boycotted == 1 & ticker == boycotted_firm) | boycotted == 0 )  %>%
filter(fy < "2026") %>%
# columns
select(where(~ !all(is.na(.)))) %>%
# Create useful columns
mutate(company_id = as.numeric(as.factor(ticker))) %>%
mutate(net_income_margin = net_income / assets) %>%
# Balance
#complete(
complete(
ticker,
fy = full_seq(unique(fy), 1)  # fills all years in the full observed range
) %>%
# fill stable company info ---
group_by(ticker) %>%
fill(company_id, boycotted, .direction = "downup") %>%
ungroup() %>%
# --- Count quarters per company-year ---
group_by(ticker, fy) %>%
mutate(n_quarters = n_distinct(fp)) %>%
ungroup() %>%
# --- Now handle both complete and incomplete in one go ---
{
bind_rows(
# 1️⃣ Keep companies with all quarters (complete)
filter(., n_quarters == 3) %>%
select(-n_quarters),
# 2️⃣ Fill missing quarters for incomplete ones
filter(., n_quarters < 3) %>%
select(-n_quarters) %>%
complete(ticker, fy, fp = c("Q1", "Q2", "Q3")) %>%
group_by(ticker) %>%
fill(company_id, boycotted, .direction = "downup") %>%
ungroup()
)
} %>%
#inpute nas for the dependent variable
# group_by(ticker) %>%
# fill(net_income_margin, .direction = "downup") %>%
# ungroup() %>%
group_by(ticker) %>%
fill(everything(), .direction = "downup") %>%
ungroup() %>%
# if a column has any missingness, drop the whole column
#select(where(~ !any(is.na(.x)))) %>%
# Turn fp (Q1, Q2, Q3, Q4) into numeric quarter fraction
mutate(
quarter_num = case_when(
fp == "Q1" ~ 0.25,
fp == "Q2" ~ 0.50,
fp == "Q3" ~ 0.75,
fp == "Q4" ~ 1.00,
TRUE ~ NA_real_
),
# Combine fiscal year and quarter into one numeric time variable
time_numeric = fy + quarter_num) %>%
select(-quarter_num) %>%
as.data.frame() %>%
# apply treatment
{
mutate(., boycotted = ifelse(
.$ticker == boycotted_firm & .$time_numeric >= 2023.25,
1,
0
))
} %>%
# --- Remove any duplicates & tidy up ---
distinct(ticker, time_numeric, .keep_all = TRUE)
library(tidysynth)
devtools::install_github("edunford/tidysynth")
require(tidysynth)
#data("smoking")
df_clean %>% dplyr::glimpse()
df_out <-
df_clean %>%
# initial the synthetic control object
synthetic_control(outcome = net_income_margin, # outcome
unit = ticker, # unit index in the panel data
time = time_numeric, # time index in the panel data
i_unit = boycotted_firm, # unit where the intervention occurred
i_time = 2023.25, # time period when the intervention occurred
generate_placebos=T # generate placebo synthetic controls (for inference)
) %>%
# Generate the aggregate predictors used to fit the weights
# average log income, retail price of cigarettes, and proportion of the
# population between 15 and 24 years of age from 1980 - 1988
generate_predictor(time_window = 2009.25:2025.75,
shares_basic = mean(shares_basic, na.rm = T),
assets = mean(assets, na.rm = T),
equity = mean(equity, na.rm = T),
cash = mean(cash, na.rm = T)) %>%
#
# # average in the donor pool from 1984 - 1988
# Purpose: match underlying demographic/economic environment
generate_predictor(time_window = 2009.25:2023.25,
avg_shares = mean(shares_basic),
avg_assets = mean(assets))
# # Lagged net_income_margin
generate_predictor(time_window = 2019,
margin_2019 = net_income_margin)
df_out <-
df_clean %>%
# initial the synthetic control object
synthetic_control(outcome = net_income_margin, # outcome
unit = ticker, # unit index in the panel data
time = time_numeric, # time index in the panel data
i_unit = boycotted_firm, # unit where the intervention occurred
i_time = 2023.25, # time period when the intervention occurred
generate_placebos=T # generate placebo synthetic controls (for inference)
) %>%
# Generate the aggregate predictors used to fit the weights
# average log income, retail price of cigarettes, and proportion of the
# population between 15 and 24 years of age from 1980 - 1988
generate_predictor(time_window = 2009.25:2025.75,
shares_basic = mean(shares_basic, na.rm = T),
assets = mean(assets, na.rm = T),
equity = mean(equity, na.rm = T),
cash = mean(cash, na.rm = T)) %>%
#
# # average in the donor pool from 1984 - 1988
# Purpose: match underlying demographic/economic environment
generate_predictor(time_window = 2009.25:2023.25,
avg_shares = mean(shares_basic),
avg_assets = mean(assets)) %>%
# # Lagged net_income_margin
generate_predictor(time_window = 2019,
margin_2019 = net_income_margin) %>%
generate_predictor(time_window = 2020,
margin_2020 = net_income_margin) %>%
generate_predictor(time_window = 2021,
margin_2021 = net_income_margin) %>%
generate_predictor(time_window = 2022,
margin_2022 = net_income_margin) %>%
# Generate the fitted weights for the synthetic control
generate_weights(optimization_window = 2009.25:2025.75, # time to use in the optimization task
margin_ipop = .02,sigf_ipop = 7,bound_ipop = 6 # optimizer options
) %>%
# Generate the synthetic control
generate_control()
df_out  %>% plot_trends()
df_out %>% plot_differences()
df_out %>% plot_weights()
df_out %>% grab_balance_table()
df_out %>% plot_placebos()
df_out %>% plot_placebos(prune = FALSE)
df_out %>% plot_mspe_ratio()
df_out %>% grab_significance()
df_out
df_out %>%
tidyr::unnest(cols = c(.outcome))
df_out  %>% plot_trends()
df_clean %>%  ggplot(aes(time_numeric, net_income_margin, colour = ticker)) + geom_point() + geom_line()
df_clean %>%  ggplot(aes(time_numeric, shares_basic, colour = ticker)) + geom_point() + geom_line()
df_clean %>%  ggplot(aes(time_numeric, assets, colour = ticker)) + geom_point() + geom_line()
#data("smoking")
df_clean %>% dplyr::glimpse()
df_out <-
df_clean %>%
# initial the synthetic control object
synthetic_control(outcome = net_income_margin, # outcome
unit = ticker, # unit index in the panel data
time = time_numeric, # time index in the panel data
i_unit = boycotted_firm, # unit where the intervention occurred
i_time = 2023.25, # time period when the intervention occurred
generate_placebos=T # generate placebo synthetic controls (for inference)
) %>%
# Generate the aggregate predictors used to fit the weights
# average log income, retail price of cigarettes, and proportion of the
# population between 15 and 24 years of age from 1980 - 1988
generate_predictor(time_window = 2009.25:2025.75,
shares_basic = mean(shares_basic, na.rm = T),
assets = mean(assets, na.rm = T),
equity = mean(equity, na.rm = T),
cash = mean(cash, na.rm = T)) %>%
#
# # average in the donor pool from 1984 - 1988
# Purpose: match underlying demographic/economic environment
generate_predictor(time_window = 2009.25:2023.25,
#avg_shares = mean(shares_basic),
avg_assets = mean(assets)) %>%
# # Lagged net_income_margin
generate_predictor(time_window = 2019,
margin_2019 = net_income_margin) %>%
generate_predictor(time_window = 2020,
margin_2020 = net_income_margin) %>%
generate_predictor(time_window = 2021,
margin_2021 = net_income_margin) %>%
generate_predictor(time_window = 2022,
margin_2022 = net_income_margin) %>%
# Generate the fitted weights for the synthetic control
generate_weights(optimization_window = 2009.25:2025.75, # time to use in the optimization task
margin_ipop = .02,sigf_ipop = 7,bound_ipop = 6 # optimizer options
) %>%
# Generate the synthetic control
generate_control()
df_out  %>% plot_trends()
df_out <-
df_clean %>%
# initial the synthetic control object
synthetic_control(outcome = net_income_margin, # outcome
unit = ticker, # unit index in the panel data
time = time_numeric, # time index in the panel data
i_unit = boycotted_firm, # unit where the intervention occurred
i_time = 2023.25, # time period when the intervention occurred
generate_placebos=T # generate placebo synthetic controls (for inference)
) %>%
# Generate the aggregate predictors used to fit the weights
# average log income, retail price of cigarettes, and proportion of the
# population between 15 and 24 years of age from 1980 - 1988
generate_predictor(time_window = 2009.25:2025.75,
shares_basic = mean(shares_basic, na.rm = T),
assets = mean(assets, na.rm = T),
equity = mean(equity, na.rm = T),
cash = mean(cash, na.rm = T)) %>%
#
# # average in the donor pool from 1984 - 1988
# Purpose: match underlying demographic/economic environment
generate_predictor(time_window = 2009.25:2023.25,
#avg_shares = mean(shares_basic),
avg_assets = mean(assets)) %>%
# # Lagged net_income_margin
# generate_predictor(time_window = 2019,
#                      margin_2019 = net_income_margin) %>%
#
generate_predictor(time_window = 2020,
margin_2020 = net_income_margin) %>%
#
# generate_predictor(time_window = 2021,
#                    margin_2021 = net_income_margin) %>%
#
# generate_predictor(time_window = 2022,
#                    margin_2022 = net_income_margin) %>%
# Generate the fitted weights for the synthetic control
generate_weights(optimization_window = 2009.25:2025.75, # time to use in the optimization task
margin_ipop = .02,sigf_ipop = 7,bound_ipop = 6 # optimizer options
) %>%
# Generate the synthetic control
generate_control()
df_out  %>% plot_trends()
df_out %>% plot_differences()
df_out <-
df_clean %>%
# initial the synthetic control object
synthetic_control(outcome = net_income_margin, # outcome
unit = ticker, # unit index in the panel data
time = time_numeric, # time index in the panel data
i_unit = boycotted_firm, # unit where the intervention occurred
i_time = 2023.25, # time period when the intervention occurred
generate_placebos=T # generate placebo synthetic controls (for inference)
) %>%
# Generate the aggregate predictors used to fit the weights
# average log income, retail price of cigarettes, and proportion of the
# population between 15 and 24 years of age from 1980 - 1988
generate_predictor(time_window = 2009.25:2025.75,
shares_basic = mean(shares_basic, na.rm = T),
assets = mean(assets, na.rm = T),
equity = mean(equity, na.rm = T),
cash = mean(cash, na.rm = T)) %>%
#
# # average in the donor pool from 1984 - 1988
# Purpose: match underlying demographic/economic environment
generate_predictor(time_window = 2009.25:2023.25,
#avg_shares = mean(shares_basic),
avg_assets = mean(assets)) %>%
# # Lagged net_income_margin
# generate_predictor(time_window = 2019,
#                      margin_2019 = net_income_margin) %>%
#
#generate_predictor(time_window = 2020,
#                   margin_2020 = net_income_margin) %>%
#
# generate_predictor(time_window = 2021,
#                    margin_2021 = net_income_margin) %>%
#
# generate_predictor(time_window = 2022,
#                    margin_2022 = net_income_margin) %>%
# Generate the fitted weights for the synthetic control
generate_weights(optimization_window = 2009.25:2025.75, # time to use in the optimization task
margin_ipop = .02,sigf_ipop = 7,bound_ipop = 6 # optimizer options
) %>%
# Generate the synthetic control
generate_control()
df_out  %>% plot_trends()
df_out %>% plot_differences()
df_out %>% plot_placebos(prune = FALSE)
